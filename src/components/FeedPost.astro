---
interface Props {
  id: string;
  authorName: string;
  authorAvatar?: string;
  content: string;
  timestamp: string;
  isPinned?: boolean;
  isAnnouncement?: boolean;
  likeCount?: number;
  replyCount?: number;
  mediaUrls?: string[];
}

const {
  id,
  authorName,
  authorAvatar,
  content,
  timestamp,
  isPinned = false,
  isAnnouncement = false,
  likeCount = 0,
  replyCount = 0,
  mediaUrls = [],
} = Astro.props;

// Format timestamp for display
function formatTimestamp(ts: string): string {
  const date = new Date(ts);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  
  return date.toLocaleDateString();
}

const formattedTime = formatTimestamp(timestamp);
---

<article 
  data-post-id={id}
  class={`feed-post bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-lg p-4 hover:border-zinc-300 dark:hover:border-zinc-700 transition-colors ${isPinned ? 'border-purple-300 dark:border-purple-700' : ''}`}
>
  <!-- Pinned/Announcement Badge -->
  {(isPinned || isAnnouncement) && (
    <div class="flex items-center gap-2 mb-3 text-xs font-semibold">
      {isPinned && (
        <span class="flex items-center gap-1 text-purple-600 dark:text-purple-400">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="17" x2="12" y2="22"></line>
            <path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"></path>
          </svg>
          PINNED
        </span>
      )}
      {isAnnouncement && (
        <span class="flex items-center gap-1 text-amber-600 dark:text-amber-400">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10.5 5H19a2 2 0 0 1 2 2v8.5"></path>
            <path d="M17 11h-.5"></path>
            <path d="M19 19H5a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2"></path>
            <path d="M2 5l20 14"></path>
          </svg>
          ANNOUNCEMENT
        </span>
      )}
    </div>
  )}
  
  <!-- Author Header -->
  <div class="flex items-start gap-3 mb-3">
    <div class="flex-shrink-0">
      {authorAvatar ? (
        <img 
          src={authorAvatar} 
          alt={authorName}
          class="w-10 h-10 rounded-full object-cover"
        />
      ) : (
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-cyan-400 flex items-center justify-center text-white font-bold text-sm">
          {authorName.charAt(0).toUpperCase()}
        </div>
      )}
    </div>
    
    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2">
        <span class="font-semibold text-zinc-900 dark:text-white">{authorName}</span>
        <span class="text-xs text-zinc-500 dark:text-zinc-400">{formattedTime}</span>
      </div>
    </div>
    
    <button class="post-menu-btn text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="1"></circle>
        <circle cx="12" cy="5" r="1"></circle>
        <circle cx="12" cy="19" r="1"></circle>
      </svg>
    </button>
  </div>
  
  <!-- Content -->
  <div class="mb-3 text-zinc-800 dark:text-zinc-200 whitespace-pre-wrap">
    {content}
  </div>
  
  <!-- Media (if any) -->
  {mediaUrls.length > 0 && (
    <div class="mb-3 grid gap-2" class:list={[
      mediaUrls.length === 1 ? 'grid-cols-1' : 'grid-cols-2'
    ]}>
      {mediaUrls.map(url => (
        <img 
          src={url} 
          alt="Post media"
          class="w-full rounded-lg object-cover max-h-96"
        />
      ))}
    </div>
  )}
  
  <!-- Actions -->
  <div class="flex items-center gap-4 pt-3 border-t border-zinc-200 dark:border-zinc-800">
    <button 
      class="like-btn flex items-center gap-1.5 text-sm font-medium text-zinc-600 dark:text-zinc-400 hover:text-purple-600 dark:hover:text-purple-400 transition-colors"
      data-post-id={id}
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M7 10v12"></path>
        <path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"></path>
      </svg>
      <span class="like-count">{likeCount}</span>
    </button>
    
    <button 
      class="reply-btn flex items-center gap-1.5 text-sm font-medium text-zinc-600 dark:text-zinc-400 hover:text-purple-600 dark:hover:text-purple-400 transition-colors"
      data-post-id={id}
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      <span>{replyCount}</span>
    </button>
    
    <button 
      class="share-btn flex items-center gap-1.5 text-sm font-medium text-zinc-600 dark:text-zinc-400 hover:text-purple-600 dark:hover:text-purple-400 transition-colors"
      data-post-id={id}
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
        <polyline points="16 6 12 2 8 6"></polyline>
        <line x1="12" y1="2" x2="12" y2="15"></line>
      </svg>
      <span>Share</span>
    </button>
  </div>
</article>

<script>
  // Handle like button clicks
  document.addEventListener('click', (e) => {
    const likeBtn = (e.target as HTMLElement).closest('.like-btn');
    if (likeBtn) {
      const postId = likeBtn.getAttribute('data-post-id');
      const countSpan = likeBtn.querySelector('.like-count');
      
      if (countSpan) {
        const currentCount = parseInt(countSpan.textContent || '0');
        countSpan.textContent = String(currentCount + 1);
        
        // In production, would call API to persist like
        console.log('Liked post:', postId);
      }
    }
    
    // Handle reply button clicks
    const replyBtn = (e.target as HTMLElement).closest('.reply-btn');
    if (replyBtn) {
      const postId = replyBtn.getAttribute('data-post-id');
      console.log('Reply to post:', postId);
      // In production, would open reply modal or expand comment section
    }
    
    // Handle share button clicks
    const shareBtn = (e.target as HTMLElement).closest('.share-btn');
    if (shareBtn) {
      const postId = shareBtn.getAttribute('data-post-id');
      console.log('Share post:', postId);
      // In production, would open share modal
    }
    
    // Handle post menu clicks
    const menuBtn = (e.target as HTMLElement).closest('.post-menu-btn');
    if (menuBtn) {
      console.log('Open post menu');
      // In production, would show context menu
    }
  });
</script>
